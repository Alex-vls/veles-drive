# Telegram Bot и Mini App - Документация

## Обзор

Telegram Bot и Mini App для платформы VELES AUTO предоставляют удобный интерфейс для управления проектами, продажами, автомобилями и другими функциями системы прямо из Telegram.

## Архитектура

### Компоненты

1. **Telegram Bot** - основной бот для взаимодействия с пользователями
2. **Mini App** - веб-приложение, встроенное в Telegram
3. **Webhook Handler** - обработчик входящих сообщений от Telegram
4. **Notification Service** - сервис для отправки уведомлений
5. **State Management** - управление состояниями пользователей

### Модели данных

#### TelegramUser
Связывает пользователей Django с Telegram аккаунтами:
- `user` - связь с Django User
- `telegram_id` - уникальный ID в Telegram
- `username`, `first_name`, `last_name` - данные профиля
- `language_code` - язык интерфейса
- `is_active` - активность профиля

#### TelegramChat
Хранит информацию о чатах:
- `chat_id` - уникальный ID чата
- `chat_type` - тип чата (private, group, supergroup, channel)
- `title`, `username` - название и username чата

#### TelegramMessage
Сообщения в чатах:
- `message_id` - ID сообщения
- `chat`, `from_user` - связь с чатом и отправителем
- `text`, `message_type` - содержимое и тип сообщения
- `reply_to_message` - ответ на сообщение

#### TelegramNotification
Уведомления для пользователей:
- `user` - получатель уведомления
- `notification_type` - тип уведомления
- `title`, `message` - заголовок и текст
- `data` - дополнительные данные (JSON)
- `is_sent`, `sent_at` - статус отправки

#### TelegramBotSettings
Настройки бота:
- `bot_token` - токен бота от BotFather
- `bot_username` - username бота
- `webhook_url` - URL для webhook
- `is_active` - активность бота

#### TelegramMiniAppSession
Сессии для Mini App:
- `user` - пользователь сессии
- `session_id` - уникальный ID сессии
- `init_data` - данные инициализации от Telegram
- `is_active` - активность сессии

#### TelegramCommand
Команды бота:
- `command` - название команды
- `description` - описание команды
- `handler_function` - функция-обработчик
- `is_active` - активность команды

#### TelegramInlineKeyboard
Inline клавиатуры:
- `name` - название клавиатуры
- `description` - описание
- `keyboard_data` - данные клавиатуры (JSON)
- `is_active` - активность клавиатуры

#### TelegramUserState
Состояния пользователей для FSM:
- `user` - пользователь
- `current_state` - текущее состояние
- `state_data` - данные состояния (JSON)

## API Endpoints

### Webhook
```
POST /telegram/webhook/
```
Обработчик входящих сообщений от Telegram.

### Mini App API

#### Аутентификация
```
POST /telegram/api/auth/
```
Аутентификация пользователя для Mini App.

**Параметры:**
- `init_data` - данные инициализации от Telegram

**Ответ:**
```json
{
    "session_id": "session_123456789_1234567890",
    "user": {
        "id": 1,
        "username": "demo_user",
        "telegram_id": 123456789
    }
}
```

#### Получение данных
```
GET /telegram/api/data/?session_id=<session_id>
```
Получение данных для Mini App.

**Ответ:**
```json
{
    "user": {
        "id": 1,
        "username": "demo_user",
        "telegram_id": 123456789
    },
    "projects": [...],
    "tasks": [...],
    "sales": [...],
    "cars": [...],
    "companies": [...]
}
```

#### Выполнение действий
```
POST /telegram/api/action/
```
Выполнение действий из Mini App.

**Параметры:**
- `action` - тип действия
- `data` - данные для действия

**Поддерживаемые действия:**
- `create_task` - создание задачи
- `update_task` - обновление задачи
- `create_sale` - создание продажи
- `send_notification` - отправка уведомления

## Команды бота

### Основные команды

#### /start
Запуск бота и показ главного меню.

#### /help
Показать справку по командам.

#### /projects
Показать список проектов пользователя.

#### /sales
Показать продажи пользователя.

#### /cars
Показать автомобили пользователя.

#### /companies
Показать компании пользователя.

#### /analytics
Показать аналитику.

#### /settings
Настройки пользователя.

### Callback команды

#### projects
Показать список проектов с inline клавиатурой.

#### sales
Показать список продаж с inline клавиатурой.

#### cars
Показать список автомобилей.

#### companies
Показать список компаний.

#### analytics
Показать аналитику с ссылкой на Mini App.

#### settings
Показать настройки пользователя.

## Уведомления

### Типы уведомлений

1. **task_assigned** - назначение задачи
2. **task_completed** - завершение задачи
3. **task_overdue** - просроченная задача
4. **sale_created** - создание продажи
5. **sale_completed** - завершение продажи
6. **project_update** - обновление проекта
7. **system_alert** - системное уведомление
8. **reminder** - напоминание

### Автоматические уведомления

Система автоматически отправляет уведомления при:
- Назначении задачи пользователю
- Завершении задачи
- Создании продажи
- Обновлении проекта
- Создании заказа на обслуживание
- Крупных финансовых операциях (>100k)
- Изменении статуса автомобиля
- Верификации компании

## Mini App

### Функциональность

Mini App предоставляет полнофункциональный интерфейс для:
- Управления проектами и задачами
- Просмотра и создания продаж
- Управления автомобилями
- Просмотра аналитики
- Настройки профиля

### Интеграция с Telegram

Mini App интегрируется с Telegram через:
- Telegram Web App API
- Валидацию init_data
- Сессии пользователей
- Уведомления

### Безопасность

- Валидация init_data от Telegram
- Проверка подписи данных
- Сессии с ограниченным временем жизни
- Аутентификация через Telegram

## Административная панель

### Доступ
```
/telegram-admin/
```

### Функции

1. **Управление пользователями**
   - Просмотр Telegram пользователей
   - Редактирование профилей
   - Управление активностью

2. **Управление уведомлениями**
   - Просмотр всех уведомлений
   - Массовая отправка
   - Статистика отправки

3. **Настройки бота**
   - Конфигурация токена
   - Настройка webhook
   - Управление командами

4. **Мониторинг**
   - Статистика использования
   - Логи сообщений
   - Активные сессии

## Установка и настройка

### 1. Создание бота

1. Обратитесь к @BotFather в Telegram
2. Создайте нового бота командой `/newbot`
3. Получите токен бота
4. Настройте команды бота

### 2. Настройка webhook

```bash
# Установка webhook
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
     -H "Content-Type: application/json" \
     -d '{"url": "https://api.veles-drive.ru/telegram/webhook/"}'
```

### 3. Загрузка демо-данных

```bash
python manage.py load_telegram_demo_data
```

### 4. Создание Mini App

1. Создайте веб-приложение
2. Настройте интеграцию с Telegram Web App API
3. Добавьте в BotFather через `/newapp`

## Разработка

### Добавление новых команд

1. Создайте функцию-обработчик в `views.py`
2. Добавьте команду в базу данных
3. Обновите обработчик callback_query

### Добавление новых уведомлений

1. Создайте сигнал в `signals.py`
2. Добавьте тип уведомления в модель
3. Настройте шаблон сообщения

### Расширение Mini App

1. Добавьте новые API endpoints
2. Обновите фронтенд
3. Протестируйте интеграцию

## Мониторинг и логирование

### Логи

Все операции бота логируются в:
- Django logs
- Telegram API responses
- Error tracking (Sentry)

### Метрики

Отслеживаемые метрики:
- Количество активных пользователей
- Количество отправленных уведомлений
- Время ответа API
- Ошибки валидации

## Безопасность

### Рекомендации

1. **Токены бота**
   - Храните токены в переменных окружения
   - Регулярно обновляйте токены
   - Ограничьте доступ к токенам

2. **Webhook**
   - Используйте HTTPS
   - Валидируйте входящие данные
   - Ограничьте размер запросов

3. **Пользовательские данные**
   - Шифруйте чувствительные данные
   - Ограничьте доступ к персональным данным
   - Соблюдайте GDPR

4. **API**
   - Используйте rate limiting
   - Валидируйте все входные данные
   - Логируйте подозрительную активность

## Troubleshooting

### Частые проблемы

1. **Webhook не работает**
   - Проверьте URL webhook
   - Убедитесь в доступности сервера
   - Проверьте SSL сертификат

2. **Уведомления не отправляются**
   - Проверьте токен бота
   - Убедитесь в активности пользователя
   - Проверьте логи ошибок

3. **Mini App не загружается**
   - Проверьте валидацию init_data
   - Убедитесь в правильности URL
   - Проверьте CORS настройки

### Отладка

```python
# Включение отладки
import logging
logging.getLogger('telegram_bot').setLevel(logging.DEBUG)

# Проверка webhook
python manage.py shell
from telegram_bot.services import TelegramBotService
bot = TelegramBotService()
print(bot.get_webhook_info())
```

## Контакты

Для вопросов по Telegram Bot и Mini App обращайтесь к команде разработки VELES AUTO. 