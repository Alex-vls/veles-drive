#!/bin/bash

# üöó –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Veles Drive –≤ Kubernetes

set -e

echo "üöÄ VELES DRIVE - –ü–æ–ª–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Kubernetes"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ kubectl
if ! command -v kubectl &> /dev/null; then
    echo "‚ùå kubectl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É..."
if ! kubectl cluster-info &> /dev/null; then
    echo "‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä—É"
    exit 1
fi

echo "‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"

# –®–∞–≥ 1: –°–±–æ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤
echo ""
echo "üì¶ –®–∞–≥ 1: –°–±–æ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤"
echo "------------------------------------------"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Docker Hub
echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Docker Hub..."
if ! docker info &> /dev/null; then
    echo "‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Docker daemon"
    exit 1
fi

# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤
echo "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
./scripts/build-and-push-images.sh

echo "‚úÖ –û–±—Ä–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Docker Hub"

# –®–∞–≥ 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Kubernetes
echo ""
echo "üöÄ –®–∞–≥ 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Kubernetes"
echo "-----------------------------------"

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üìã –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤..."
./scripts/deploy-to-k8s.sh

echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –≤ Kubernetes"

# –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
echo ""
echo "üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
echo "-------------------------------"

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
./scripts/k8s-monitoring.sh

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo ""
echo "üåç –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏"
echo "-----------------------------"

echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend..."
if curl -I -k https://veles-drive.ru 2>/dev/null | grep -q "200\|301\|302"; then
    echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è Frontend –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, DNS –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)"
fi

echo "üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
if curl -I -k https://api.veles-drive.ru 2>/dev/null | grep -q "200\|301\|302"; then
    echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è API –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, DNS –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è)"
fi

# –®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo ""
echo "üéâ –®–∞–≥ 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "================================="

echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏:"
echo "   - Namespace: veles-drive"
echo "   - –î–æ–º–µ–Ω—ã: veles-drive.ru, api.veles-drive.ru"
echo "   - SSL: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Cert-Manager"
echo "   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Kubernetes –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π"

echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   # –°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤"
echo "   kubectl get pods -n veles-drive"
echo ""
echo "   # –õ–æ–≥–∏ Backend"
echo "   kubectl logs -n veles-drive -l app=veles-drive-backend"
echo ""
echo "   # –õ–æ–≥–∏ Frontend"
echo "   kubectl logs -n veles-drive -l app=veles-drive-frontend"
echo ""
echo "   # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
echo "   ./scripts/k8s-monitoring.sh"
echo ""
echo "   # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Backend"
echo "   kubectl scale deployment veles-drive-backend -n veles-drive --replicas=3"
echo ""
echo "   # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–∞"
echo "   kubectl set image deployment/veles-drive-backend backend=alsx12/veles-drive-backend:latest -n veles-drive"

echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
echo "   - https://veles-drive.ru"
echo "   - https://www.veles-drive.ru"
echo "   - https://api.veles-drive.ru"

echo ""
echo "‚ö†Ô∏è –í–∞–∂–Ω–æ:"
echo "   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DNS –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo "   - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
echo "   - –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç"

echo ""
echo "‚úÖ VELES DRIVE —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ Kubernetes!"
echo "üöÄ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"
